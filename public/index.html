<!-- index.html -->
<html>
  <head>
    <title>List of Activities</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react-with-addons.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/2.5.2/rx.all.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs-dom/2.0.7/rx.dom.js"></script>
  </head>
  <body>
    <script type="text/jsx">

//array find() polyfill from moz site
if (!Array.prototype.find) {
  Array.prototype.find = function(predicate) {
    if (this == null) {
      throw new TypeError('Array.prototype.find called on null or undefined');
    }
    if (typeof predicate !== 'function') {
      throw new TypeError('predicate must be a function');
    }
    var list = Object(this);
    var length = list.length >>> 0;
    var thisArg = arguments[1];
    var value;

    for (var i = 0; i < length; i++) {
      value = list[i];
      if (predicate.call(thisArg, value, i, list)) {
        return value;
      }
    }
    return undefined;
  };
}


      // code here

      var Activity = React.createClass({
        render: function() {
          return(
            <li>{this.props.activity.id} - {this.props.activity.name}</li>
          );
        }
      });

      var ActivityList = React.createClass({
        render: function() {

          var activities = this.props.activities;
          var nodes = this.props.activityList.map(function(activityListItem) {
            var activity = activities.find(function(x) {
              return x.id === activityListItem.id;
            });
            var activityView = {
              id: activityListItem.id,
              name: (activity == 'undefined' ? 'loading...' : activity.name)
            };
            return(
              <Activity activity={activity}/>
            );
          });

          return(
            <ul>
              {nodes}
            </ul>
          );
        }
      });

      var ActivityScreen = React.createClass({
        componentDidMount: function() {

          var eventUrlStream =
          // Rx.Observable.fromPromis(fetch(this.props.url)).select(function(request){
          //   return request.json();
          // })
            Rx.DOM.Request.getJSON(this.props.url)
            .selectMany(function(data) {
                console.log('stream loaded data:' + data);
                return Rx.Observable.fromArray(data);
            })
            ;

          var eventStream =
          eventUrlStream
          .selectMany(function(eventUrl) {
            console.log('loading event from url:' + eventUrl);
            return Rx.DOM.Request.getJSON(eventUrl);
          })
          .select(function(data) {
            console.log('loaded event:' + data);
            return data;
          })
          ;


          var setState = this.setState.bind(this);  //it is not autobound by react
          var jsonFetchObservable = function(url) {
            return Rx.Observable.fromPromis(fetch(url)).select(function(request){
              return request.json();
            });
          }

          var activitiesStream =
            Rx.DOM.Request.getJSON('activities.json')
              .selectMany(function(data) {
                  console.log('stream loaded data for activities :' + data);
                  return Rx.Observable.fromArray(data);
              })
              .selectMany(function(eventUrl) {
                console.log('loading activity event from url:' + eventUrl);
                return Rx.DOM.Request.getJSON(eventUrl);
              });


              var stateChangeStream =
              activitiesStream
              .merge(eventStream)
          .scan(this.state, function(state, eventData) {
              console.log('got event:' + eventData.eventType);
              //do hardcoding now
              if (eventData.eventType === 'ActivityAdded') {
                console.log(' added activity ' + eventData.activityId);
                  return React.addons.update(state, {
                    activityList: {
                      $push: [{
                        id: eventData.activityId,
                      }]
                    }
                  });
                }
                  else if (eventData.eventType === 'ActivityCreated') {
                    console.log(' created activity ' + eventData.id);
                      return React.addons.update(state, {
                        activities: {
                          $push: [{
                            id: eventData.id,
                            name: eventData.activityName
                          }]
                        }
                      });
                    }
                else
                  return state;
          });

          stateChangeStream
          //.observeOn(Rx.Scheduler.requestAnimationFrame)  //seems like react works without forcing "update in UI thread", but it is needed for debugger; it is much slower too
          .subscribe(
              function (newState) {
                  console.log('got state update:' + newState.activityList);
                  // just update state
                  setState( newState );
              },
              function (error) {
                  // Log the error
                  console.error('got error');
              }
          );

        },
        getInitialState: function() {
          return({
            activityList : [],
            activities : []
          });
        },
        render: function() {
          return(
            <body>
            <button type="button" name="button"></button>
            <ActivityList activityList={this.state.activityList} activities={this.state.activities}/>
            </body>
          );
        }
      });

      React.render(
        <ActivityScreen url="events.json" pollInterval={2000}/>,
        document.body
      );
    </script>
  </body>
</html>
