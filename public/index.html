<!-- index.html -->
<html>
  <head>
    <title>List of Activities</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react-with-addons.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/2.5.2/rx.all.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs-dom/2.0.7/rx.dom.js"></script>
  </head>
  <body>
    <script type="text/jsx">

      // code here

      var Activity = React.createClass({
        render: function() {
          return(
            <li>{this.props.data.name}</li>
          );
        }
      });

      var ActivityList = React.createClass({
        render: function() {

          var nodes = this.props.data.map(function(activity) {
            return(
              <Activity data={activity}/>
            );
          });

          return(
            <ul>
              {nodes}
            </ul>
          );
        }
      });

      var ActivityScreen = React.createClass({
        loadFromServer: function() {
          $.ajax({
            url: this.props.url,
            dataType: 'json',
            success: function(data) {
              this.setState({data: data});
            }.bind(this),
            error: function(xhr, status, err) {
              console.error(this.props.url, status, err.toString());
            }.bind(this)
          });
        },
        componentDidMount: function() {
          // this.loadFromServer();
          // setInterval(this.loadFromServer, this.props.pollInterval);

          var eventUrlStream =
          // Rx.Observable.fromPromis(fetch(this.props.url)).select(function(request){
          //   return request.json();
          // })
            Rx.DOM.Request.getJSON(this.props.url)
            .selectMany(function(data) {
                console.log('stream loaded data:' + data);
                return Rx.Observable.fromArray(data);
            })
            ;

          var eventStream =
          eventUrlStream
          .selectMany(function(eventUrl) {
            console.log('loading event from url:' + eventUrl);
            return Rx.DOM.Request.getJSON(eventUrl);
          })
          .select(function(data) {
            console.log('loaded event:' + data);
            return data;
          })
          ;


          var setState = this.setState.bind(this);  //it is not autobound by react
          var jsonFetchObservable = function(url) {
            return Rx.Observable.fromPromis(fetch(url)).select(function(request){
              return request.json();
            });
          }

          eventStream
          .scan(this.state, function(state, eventData) {
              console.log('got event:' + eventData.eventType);
              //do hardcoding now
              if (eventData.eventType === 'ActivityAdded')
                  return {
                    data: React.addons.update(state.data, {
                    $push: [{
                      name: eventData.activityName
                    }]
                  })
                  };
                return state;
          })
          //.observeOn(Rx.Scheduler.requestAnimationFrame)  //seems like react works without forcing "update in UI thread"
          .subscribe(
              function (newState) {
                  console.log('got state update:' + newState.data);
                  // just update state
                  setState( newState );
              },
              function (error) {
                  // Log the error
                  console.error('got error');
              }
          );

        },
        getInitialState: function() {
          return({
            data : []
          });
        },
        render: function() {
          return(
            <body>
            <ActivityList data={this.state.data}/>
            </body>
          );
        }
      });

      React.render(
        <ActivityScreen url="events.json" pollInterval={2000}/>,
        document.body
      );
    </script>
  </body>
</html>
